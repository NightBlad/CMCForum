<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông tin cá nhân</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            background-color: #f8f9fa;
        }
        /* Sidebar giống homepage */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 60px;
            height: 100vh;
            background-color: #fafafa;
            text-align: center;
            padding-top: 20px;
            overflow-y: auto;
        }

            .sidebar img {
                width: 40px;
                margin: 20px 0;
                cursor: pointer;
                transition: transform 0.2s;
            }

                .sidebar img:hover {
                    transform: scale(1.1);
                }
        /* Nội dung chính */
        .content {
            flex-grow: 1;
            padding: 20px;
            background-color: #f8f9fa;
            margin-left: 60px;
        }

        h2 {
            margin-bottom: 15px;
        }
        /* Card thông tin cá nhân kiểu flat giống homepage */
        .user-info {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: #fff;
            max-width: 600px;
            margin: 0 auto;
        }

            .user-info h3 {
                color: #2c3e50;
                margin-bottom: 20px;
                font-size: 24px;
            }

            .user-info p {
                margin-bottom: 15px;
                font-size: 16px;
                display: flex;
                justify-content: space-between;
            }

                .user-info p strong {
                    color: #34495e;
                    width: 30%;
                }

                .user-info p span {
                    color: #7f8c8d;
                    width: 70%;
                    text-align: right;
                }
        /* Popup đăng bài */
        .popup {
            display: none;
            position: fixed;
            top: 20%;
            left: 30%;
            width: 40%;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

            .popup textarea {
                width: 100%;
                height: 100px;
                margin-bottom: 10px;
            }
        /* Notification popup */
        .notification-popup {
            display: none;
            position: fixed;
            top: 20%;
            left: 10%;
            width: 300px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .notification-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

            .notification-item:last-child {
                border-bottom: none;
            }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }
        /* Menu người dùng */
        .user-menu {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1001;
        }

        .user-avatar img {
            width: 40px;
            height: 40px;
            cursor: pointer;
            border-radius: 50%;
            object-fit: cover;
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            top: 50px;
            right: 0;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1002;
            width: 150px;
        }

        .menu-item {
            display: block;
            padding: 10px 20px;
            text-decoration: none;
            color: #333;
        }

            .menu-item:hover {
                background-color: #f1f1f1;
            }
        /* Add these responsive styles to your existing CSS section */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            /* Mobile sidebar at bottom */
            .sidebar {
                position: fixed;
                bottom: 0;
                top: auto;
                left: 0;
                width: 100%;
                height: 60px;
                display: flex;
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                padding: 5px;
                z-index: 1010;
                box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            }

                .sidebar img {
                    width: 30px;
                    margin: 0;
                }

            .content {
                margin-left: 0;
                margin-bottom: 70px; /* Space for bottom sidebar */
                padding: 15px;
            }

            /* User info card adjustments */
            .user-info {
                padding: 15px;
                max-width: 100%;
            }

                .user-info h3 {
                    font-size: 20px;
                    margin-bottom: 15px;
                }

                /* Adjust information layout */
                .user-info p {
                    flex-direction: column;
                    align-items: flex-start;
                    margin-bottom: 20px;
                    border-bottom: 1px solid #f0f0f0;
                    padding-bottom: 10px;
                }

                    .user-info p:last-child {
                        border-bottom: none;
                    }

                    .user-info p strong {
                        width: 100%;
                        margin-bottom: 5px;
                        color: #555;
                    }

                    .user-info p span {
                        width: 100%;
                        text-align: left;
                        font-size: 15px;
                    }

                /* Form improvements */
                .user-info form .form-label {
                    font-size: 14px;
                }

                .user-info form .form-control {
                    font-size: 15px;
                    margin-bottom: 10px;
                }

                /* Button adjustments */
                .user-info .btn {
                    width: 100%;
                    margin-bottom: 8px;
                }

                .user-info form .btn {
                    padding: 8px 12px;
                }

            /* Popup adjustments */
            .popup {
                width: 90%;
                left: 5%;
                top: 50%;
                transform: translateY(-50%);
                max-height: 80vh;
                overflow-y: auto;
            }

            .notification-popup {
                width: 90%;
                left: 5%;
                max-height: 70vh;
                overflow-y: auto;
            }

            /* User menu positioning */
            .user-menu {
                top: 5px;
                right: 5px;
            }

            .menu-dropdown {
                min-width: 120px;
            }

            .menu-item {
                padding: 12px 15px;
                font-size: 16px;
            }

            /* Provide more visual space between sections */
            .mt-4 {
                margin-top: 2rem !important;
            }
        }

        /* Extra adjustments for tiny screens */
        @media (max-width: 350px) {
            .user-info h3 {
                font-size: 18px;
            }

            .user-info form .btn {
                font-size: 14px;
                padding: 6px 10px;
            }
        }

    </style>
</head>
<body>
    <!-- Menu người dùng -->
    <div class="user-menu">
        <div class="user-avatar" onclick="toggleMenu()">
            <img src="/HinhAnh/avatar.jpg" alt="Avatar" class="rounded-circle">
        </div>
        <div class="menu-dropdown" id="menu-dropdown">
            <a href="profile.html" class="menu-item">Trang cá nhân</a>
            <a href="userinfo.html" class="menu-item">Thông tin cá nhân</a>
            <a href="#" class="menu-item" onclick="logout()">Đăng xuất</a>
        </div>
    </div>
    <!-- Sidebar -->
    <div class="sidebar">
        <img src="/HinhAnh/CMC-logo.png" alt="Logo CMC" onclick="redirectToHomepage()">
        <img src="/HinhAnh/home.png" alt="Trang chủ" onclick="redirectToHomepage()">
        <img src="/HinhAnh/like.png" alt="Lượt thích" onclick="showNotifications('likes')">
        <img src="/HinhAnh/comment.png" alt="Bình luận" onclick="showNotifications('comments')">
        <img src="/HinhAnh/bell.png" alt="Thông báo" onclick="showNotifications('approvals')">
        <img src="/HinhAnh/post.png" alt="Đăng bài" onclick="openPostPopup('create')">
    </div>
    <!-- Nội dung chính -->
    <div class="content">
        <h2>Thông tin cá nhân</h2>
        <div id="user-info" class="user-info">
            <h3>Thông tin của bạn</h3>
            <div id="info-display">
                <!-- Thông tin cá nhân sẽ được chèn vào đây -->
            </div>
            <div id="info-edit" style="display:none;">
                <form id="edit-form">
                    <div class="mb-3">
                        <label for="edit-fullname" class="form-label">Tên đầy đủ</label>
                        <input type="text" class="form-control" id="edit-fullname" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-dob" class="form-label">Ngày sinh</label>
                        <input type="date" class="form-control" id="edit-dob" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-contact" class="form-label">Liên hệ</label>
                        <input type="text" class="form-control" id="edit-contact" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Hủy</button>
                </form>
            </div>
            <button id="edit-button" class="btn btn-outline-primary mt-3" onclick="toggleEdit()">Chỉnh sửa thông tin</button>
        </div>
        <div class="user-info mt-4">
            <h3>Thông tin đăng nhập</h3>
            <div id="login-info-display">
                <p>
                    <strong>Tên đăng nhập:</strong>
                    <span id="username-display"></span>
                </p>
                <p>
                    <strong>Mật khẩu:</strong>
                    <span>••••••••</span>
                </p>
            </div>
            <div id="login-edit" style="display:none;">
                <form id="login-edit-form">
                    <div class="mb-3">
                        <label for="edit-username" class="form-label">Tên đăng nhập</label>
                        <input type="text" class="form-control" id="edit-username" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-current-password" class="form-label">Mật khẩu hiện tại</label>
                        <input type="password" class="form-control" id="edit-current-password" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-new-password" class="form-label">Mật khẩu mới</label>
                        <input type="password" class="form-control" id="edit-new-password">
                        <small class="text-muted">Để trống nếu không muốn thay đổi mật khẩu</small>
                    </div>
                    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelLoginEdit()">Hủy</button>
                </form>
            </div>
            <button id="login-edit-button" class="btn btn-outline-primary mt-3" onclick="toggleLoginEdit()">Chỉnh sửa thông tin đăng nhập</button>
        </div>
    </div>
    <!-- Popup và Overlay -->
    <div class="overlay" id="overlay"></div>
    <div class="popup" id="post-popup">
        <h3>Đăng bài mới</h3>
        <form id="post-form">
            <div class="mb-3">
                <label for="post-title" class="form-label">Tiêu đề</label>
                <input type="text" class="form-control" id="post-title" required>
            </div>
            <div class="mb-3">
                <label for="post-content" class="form-label">Nội dung</label>
                <textarea class="form-control" id="post-content" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Đăng bài</button>
            <button type="button" class="btn btn-secondary" onclick="closePostPopup()">Hủy</button>
        </form>
    </div>
    <div class="overlay" id="notification-overlay"></div>
    <div class="notification-popup" id="notification-popup">
        <h4>Thông báo</h4>
        <div id="notification-list"></div>
        <button class="btn btn-secondary mt-2 w-100" onclick="closeNotificationPopup()">Đóng</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const API_URL = 'https://universityforum-a3fnc9f9c2axfaef.canadacentral-01.azurewebsites.net/api';
        const token = localStorage.getItem('token');
        let userRole = '';
        let currentUserData = {};
        if (!token) {
            window.location.href = 'login.html';
        }

        // Update the loadUserInfo function to include username display
        async function loadUserInfo() {
            try {
                const response = await axios.get(`${API_URL}/User/Profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = response.data;
                currentUserData = user;
                userRole = user.role;

                // Update existing user info display
                const userInfoContainer = document.getElementById('info-display');
                userInfoContainer.innerHTML = `
                            <p><strong>Tên:</strong> <span>${user.fullName || 'Chưa có thông tin'}</span></p>
                            <p><strong>Ngày sinh:</strong> <span>${user.dateOfBirth ? new Date(user.dateOfBirth).toLocaleDateString('vi-VN') : 'Chưa có thông tin'}</span></p>
                            <p><strong>SDT:</strong> <span>${user.contact || 'Chưa có thông tin'}</span></p>
                            <p><strong>Vai trò:</strong> <span>${user.role || 'Chưa có thông tin'}</span></p>
                        `;

                // Update username display
                document.getElementById('username-display').textContent = user.username || 'Chưa có thông tin';

            } catch (error) {
                console.error('Lỗi khi tải thông tin cá nhân:', error);
                document.getElementById('info-display').innerHTML = '<p>Đã xảy ra lỗi khi tải thông tin cá nhân.</p>';
            }
        }
        // Check if username exists
        async function checkUsernameExists(username) {
            try {
                const response = await axios.get(`${API_URL}/User/CheckUsername`, {
                    params: { username },
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return response.data;
            } catch (error) {
                console.error('Lỗi khi kiểm tra tên đăng nhập:', error);
                return false;
            }
        }

        function toggleLoginEdit() {
            const loginEditContainer = document.getElementById('login-edit');
            const loginEditButton = document.getElementById('login-edit-button');
            const loginDisplayContainer = document.getElementById('login-info-display');

            if (loginEditContainer.style.display === 'none') {
                // Switch to edit mode
                loginEditContainer.style.display = 'block';
                loginDisplayContainer.style.display = 'none';
                loginEditButton.style.display = 'none';

                // Populate form with current data
                document.getElementById('edit-username').value = currentUserData.username || '';
                document.getElementById('edit-current-password').value = '';
                document.getElementById('edit-new-password').value = '';
            }
        }

        function cancelLoginEdit() {
            document.getElementById('login-info-display').style.display = 'block';
            document.getElementById('login-edit').style.display = 'none';
            document.getElementById('login-edit-button').style.display = 'block';
        }

        // Add username validation on blur
        document.getElementById('edit-username').addEventListener('blur', async function () {
            const username = this.value;

            // Skip validation if username hasn't changed
            if (username === currentUserData.username) {
                return;
            }

            if (username.length > 0) {
                const exists = await checkUsernameExists(username);

                if (exists) {
                    // Show error message
                    if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('text-danger')) {
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'text-danger';
                        errorMessage.textContent = 'Tên đăng nhập này đã tồn tại, vui lòng chọn tên khác';
                        this.insertAdjacentElement('afterend', errorMessage);
                    }
                } else {
                    // Remove error message if exists
                    if (this.nextElementSibling && this.nextElementSibling.classList.contains('text-danger')) {
                        this.nextElementSibling.remove();
                    }
                }
            }
        });

        // Register the login edit form submit event
        document.getElementById('login-edit-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const username = document.getElementById('edit-username').value;
            const currentPassword = document.getElementById('edit-current-password').value;
            const newPassword = document.getElementById('edit-new-password').value;

            // Check if there's an error message visible
            const hasError = document.getElementById('edit-username').nextElementSibling &&
                document.getElementById('edit-username').nextElementSibling.classList.contains('text-danger');

            if (hasError) {
                alert('Vui lòng sửa lỗi trước khi gửi form');
                return;
            }

            // If username has changed, verify it's available
            if (username !== currentUserData.username) {
                const exists = await checkUsernameExists(username);
                if (exists) {
                    alert('Tên đăng nhập đã tồn tại, vui lòng chọn tên khác');
                    return;
                }
            }

            const updatedLoginData = {
                username: username,
                currentPassword: currentPassword,
                newPassword: newPassword
            };

            try {
                const response = await axios.put(`${API_URL}/User/UpdateLogin`, updatedLoginData, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Update successful
                alert('Cập nhật thông tin đăng nhập thành công!');
                cancelLoginEdit();
                loadUserInfo(); // Reload the user info
            } catch (error) {
                console.error('Lỗi khi cập nhật thông tin đăng nhập:', error);

                // Show specific error message if available
                if (error.response && error.response.data && error.response.data.message) {
                    alert(error.response.data.message);
                } else {
                    alert('Không thể cập nhật thông tin đăng nhập. Vui lòng thử lại sau.');
                }
            }
        });
        function toggleEdit() {
            const displayContainer = document.getElementById('info-display');
            const editContainer = document.getElementById('info-edit');
            const editButton = document.getElementById('edit-button');

            if (displayContainer.style.display !== 'none') {
                // Switch to edit mode
                displayContainer.style.display = 'none';
                editContainer.style.display = 'block';
                editButton.style.display = 'none';

                // Populate form with current data
                document.getElementById('edit-fullname').value = currentUserData.fullName || '';
                document.getElementById('edit-dob').value = currentUserData.dateOfBirth ? new Date(currentUserData.dateOfBirth).toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).split('/').reverse().join('-') : '';
                document.getElementById('edit-contact').value = currentUserData.contact || '';
            }
        }

        function cancelEdit() {
            document.getElementById('info-display').style.display = 'block';
            document.getElementById('info-edit').style.display = 'none';
            document.getElementById('edit-button').style.display = 'block';
        }

        // Register the form submit event
        document.getElementById('edit-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const updatedData = {
                fullName: document.getElementById('edit-fullname').value,
                dateOfBirth: document.getElementById('edit-dob').value,
                contact: document.getElementById('edit-contact').value
            };

            try {
                const response = await axios.put(`${API_URL}/User/UpdateProfile`, updatedData, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Update successful
                alert('Cập nhật thông tin thành công!');
                cancelEdit();
                loadUserInfo(); // Reload the user info
            } catch (error) {
                console.error('Lỗi khi cập nhật thông tin:', error);
                alert('Không thể cập nhật thông tin. Vui lòng thử lại sau.');
            }
        });
        // Các hàm hỗ trợ giống homepage
        function openPostPopup() {
            document.getElementById('post-popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }
        function closePostPopup() {
            document.getElementById('post-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
        function toggleMenu() {
            const menu = document.getElementById('menu-dropdown');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }
        // Replace the showNotifications function in homepage.html
        async function showNotifications(type) {
            try {
                const response = await axios.get(`${API_URL}/Notification`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const notifications = response.data;

                const notificationList = document.getElementById('notification-list');
                notificationList.innerHTML = '';

                // Filter notifications based on type or show all if type is 'all'
                const filteredNotifications = type === 'all'
                    ? notifications
                    : notifications.filter(n => {
                        if (type === 'likes') return n.content.includes('thích');
                        if (type === 'comments') return n.content.includes('bình luận');
                        if (type === 'approvals') return n.content.includes('đã được duyệt') || n.content.includes('đã bị từ chối');
                        return false;
                    });

                if (filteredNotifications.length === 0) {
                    notificationList.innerHTML = '<p>Không có thông báo nào.</p>';
                } else {
                    filteredNotifications.forEach(notification => {
                        const item = document.createElement('div');
                        item.className = 'notification-item';
                        item.style.cursor = 'pointer';

                        // Format the notification content to be more readable
                        let content = notification.content;

                        // Add status indicator based on content
                        let statusClass = '';
                        if (content.includes('đã được duyệt')) {
                            statusClass = 'text-success';
                        } else if (content.includes('đã bị từ chối')) {
                            statusClass = 'text-danger';
                        }

                        item.innerHTML = `
                                    <p class="${statusClass}">${content}</p>
                                    <small>${new Date(notification.createdAt).toLocaleString()}</small>
                                `;

                        // Add click event to navigate to the post if postId exists
                        if (notification.postId) {
                            item.addEventListener('click', () => {
                                if (notification.content.includes('đã bị từ chối')) {
                                    // For rejected posts, just show an alert
                                    alert('Bài viết này đã bị từ chối bởi admin.');
                                } else {
                                    // For other notifications, navigate to the post
                                    window.location.href = `post-detail.html?id=${notification.postId}`;
                                }
                            });
                        }

                        notificationList.appendChild(item);
                    });
                }

                document.getElementById('notification-popup').style.display = 'block';
                document.getElementById('notification-overlay').style.display = 'block';
            } catch (error) {
                console.error('Lỗi khi tải thông báo:', error);
                alert('Không thể tải thông báo. Vui lòng thử lại sau.');
            }
        }
        function closeNotificationPopup() {
            document.getElementById('notification-popup').style.display = 'none';
            document.getElementById('notification-overlay').style.display = 'none';
        }

        // Hàm chuyển hướng dựa trên vai trò người dùng
        function redirectToHomepage() {
            if (userRole === 'Admin') {
                window.location.href = 'admin-homepage.html';
            } else {
                window.location.href = 'homepage.html';
            }
        }
        // Add this function to enhance mobile experience
        function setupMobileEnhancements() {
            // Check if we're on a mobile device by screen width
            if (window.innerWidth <= 768) {
                // Add active state visual feedback for buttons
                const buttons = document.querySelectorAll('button');
                buttons.forEach(button => {
                    button.addEventListener('touchstart', function () {
                        this.style.opacity = '0.7';
                    });

                    button.addEventListener('touchend', function () {
                        this.style.opacity = '1';
                    });
                });

                // Close menu when clicking outside
                document.addEventListener('touchstart', function (e) {
                    const menuDropdown = document.getElementById('menu-dropdown');
                    const userAvatar = document.querySelector('.user-avatar');

                    if (!userAvatar.contains(e.target) && menuDropdown.style.display === 'block') {
                        menuDropdown.style.display = 'none';
                    }
                });

                // Improve form field focus for mobile
                const formInputs = document.querySelectorAll('input, textarea');
                formInputs.forEach(input => {
                    input.addEventListener('focus', function () {
                        this.style.backgroundColor = 'rgba(255, 255, 255, 0.97)';
                        this.style.boxShadow = '0 0 0 3px rgba(0, 123, 255, 0.1)';
                    });

                    input.addEventListener('blur', function () {
                        this.style.backgroundColor = '';
                        this.style.boxShadow = '';
                    });
                });
            }
        }

        // Call this function after the page loads
        document.addEventListener('DOMContentLoaded', setupMobileEnhancements);
        window.addEventListener('resize', setupMobileEnhancements);

        // Tải thông tin cá nhân khi trang được mở
        loadUserInfo();
    </script>
</body>
</html>
